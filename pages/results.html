<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>mockup with bootstrap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="../css/jqueryFileTree.css" rel="stylesheet">
  <link href="../css/merged.css" rel="stylesheet">
  <link href="../css/bootstrap-select.css" rel="stylesheet">
  <style type="text/css">
    .centerSub {
      background-color:#eee; 
      border: 1px solid #888; 
      border-radius:3px;
      padding: 15px;
    }

    UL.jqueryFileTree LI.ext_cb {
      padding-left:5px;
    }

    #overviewTable td { border: 3px white solid; }
    #overviewTable th { 
      font-family: Verdana,Arial,Helvetica,sans-serif;
      font-weight: normal;
      font-size: .9em;
      font-color: black;
      text-align: left;
      color: black;
      margin: 0;
      padding: 5px 12px 5px 12px;
      vertical-align: top;
      border: 3px solid #FFF;
      background-color: ##f5f5f5;
    }
    #overviewTable img {
      min-width: 85px;
      min-height: 85px;
    }

    .markerSelect .bootstrap-select {
      width: 150px;
    }
  </style>

</head>

  <body>
    <div id="nav"></div>
    <div class="row-fluid">
      <div class="span3" style="height:100%;">
        <div class="well" id="files" style="height:100%;overflow:auto;">
          <div class="row-fluid span12">
            <button class="btn btn-mini btn-warning" type="button" id="fileAllButton">Select All</button>
            <button class="btn btn-mini btn-inverse" type="button" id="fileNoneButton">Deselect All</button>
            <p><span class="label label-important">Collapsing a directory deselects files under it!</span></p>
          </div>
          <div class="row-fluid span12" id="fileNav" style="overflow:auto;"></div>
        </div>
      </div>
      <div class="span9" style="">
        <div class="row-fluid">
          <div class="span12 centerSub">
            <div class="span11 offset1" id="details">
              <table>
                <tr>
                  <td><strong>Method Name</strong></td><td>FLOCK</td>
                </tr>
                <tr>
                  <td><strong>Method Version</strong></td><td>v0.1</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12 centerSub" id="overview">
            <div class="row-fluid">
              <div class="span12" style="margin-left:5px;">
                <div class="row-fluid">
                  <div class="span3">
                    <h6>Population</h6>
                    <select id="populselect" class="selectpicker" rel="populations" multiple data-selected-text-format="count>1" data-count-selected-text="{0} of {1} populations">
                    </select>
                  </div>
                  <div class="span2 markerSelect">
                    <h6>X-axis</h6>
                    <select id="xmarker" class="selectpicker" multiple rel="markers" data-selected-text-format="count>1" data-count-selected-text="{0} of {1} markers"></select>
                  </div>
                  <div class="span2 markerSelect">
                    <h6>Y-axis</h6>
                    <select id="ymarker" class="selectpicker" multiple rel="markers" data-selected-text-format="count>1" data-count-selected-text="{0} of {1} markers"></select>
                  </div>
                  <div class="span3">
                    <h6>Parameters</h6>
                    <select id="paramselect" class="selectpicker" multiple data-selected-text-format="count>1" data-count-selected-text="{0} of {1}"></select>
                  </div>
                </div>
              </div>
            </div>
            <div class="row-fluid">
              <div class="span2">
                <button class="btn btn-primary" type="button" id="updateButton">Show Result</button>
              </div>
              <div class="span10">
                <img src="../images/ajax-loader.gif" id="loading-indicator" style="display:none;"/>
              </div>
            </div>
            <div class="row-fluid" style="margin-top:5px;">
              <div class="span12">
                <div id="flock_main">
                  <div id="flock_content">
                    <table id="overviewTable"></table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>  
    </div>

    <script src="../js/jquery.min.js"></script>
    <script src="../js/jqueryFileTree.js"></script>
    <script src="../js/bootstrap-select.min.js"></script>
    <script>
      var _page = {
        init: false, //initial load flag,
        files: '',
        html: {
          opt_dc: "<option data-content='<span class=\"$c$\">&nbsp;&nbsp;&nbsp;</span>$t$'>$v$</option>",
          opt: "<option value='$v$'>$v$</option>"
        },
        fileClicked: function() {
          console.log($('[name^="fcb_"]:checked').attr("name"));
        },
        draw: function(data) {
          var imgHtml = "<img src='$imgPath$'/>";

          if(data && data.columns && data.taskDir && data.type && data.pops) {
            var cols = data.columns, 
                taskId = data.taskId,
                taskDir = data.taskDir, 
                type = data.type, 
                popId = data.popId,
                imgPostfix = (type=='pop'?popId+'.color.highlighted':'all.'+type),
                thead = '<thead><tr><th id="name"></th>', 
                tbody = '<tbody>',
                pops = data.pops;

            for(var i=0;i<cols.length;i++) {
              thead+='<th id="'+cols[i]+'">'+cols[i]+'</th>';
              tbody+='<tr><th id="'+cols[i]+'_'+cols[i]+'" headers="name">'+cols[i]+'</th>';
              for(var j=0;j<cols.length;j++) {
                tbody+='<td headers="'+cols[j]+' '+cols[i]+'">'
                +imgHtml.replace("$imgPath$", "../Tasks/"+taskId+"/"+type+"/"+cols[j]+"."+cols[i]+'.'+imgPostfix+'.png');
                +'</td>'
              }
              tbody+='</tr>';
            }
            tbody+='</tbody>';
            thead+='</tr></thead>';
            $('#overviewTable').html(thead+tbody);

            if(!this.init) {
              //if(type==='color') {
                this.popul(taskId, pops);
              //}
              this.markers(cols);
              this.params(["It's", "Not", "Ready", "Yet"]);
            }

            $('#loading-indicator').hide();
            this.initial = true;
          }
        },
        popul: function(taskId, pops) {
          var _this = this,
              $selecObj = $('#populselect');

          $.each(pops, function(i,pop){
            $selecObj.append(
              _this.html.opt_dc.replace("$c$", "popul"+(i>24?i%25+1:i))
                .replace("$t$", "Population "+i+"("+pop+")")
                .replace("$v$",i)
              );
          });
          $selecObj.selectpicker('selectAll');
          //$selecObj.change(function(){
          //  var currPopul = $selecObj.find("option:selected").val();
          //  $('#overviewH4').html(currPopul==='0'?'Overview':'Population '+currPopul);
          //  _this.ajax(taskId, currPopul==='0'?'color':'pop', currPopul);
          //});
        },
        markers: function(markers) {
          var opts = "";
          for(var i=0;i<markers.length;i++) {
            opts+=this.html.opt.replace(/\$v\$/g, markers[i]);    
          }
          $("#xmarker, #ymarker").append(opts).selectpicker("selectAll");
        },
        params: function(params) {
          var opts = "";
          for(var i=0;i<params.length;i++) {
            opts+=this.html.opt.replace(/\$v\$/g, params[i]);    
          }
          $("#paramselect").append(opts).selectpicker();
        },
        selecpicker: {
          makeSingle: function(id) {
            $('#'+id).removeAttr('multiple')
              .removeAttr('data-selected-text-format')
              .removeAttr('data-count-selected-text');
            this.refresh(id);
          },
          makeMulti: function(id) {
            var $_sel = $('#'+id);
                rel = $_sel.attr('rel');
            $_sel.attr('multiple', '')
              .attr('data-selected-text-format', 'count>1')
              .attr('data-count-selected-text', '{0} of {1} '+rel);
              console.log(rel);
            this.refresh(id);    
          },
          refresh: function(id) {
            $('#'+id).selectpicker('refresh', 'deselectAll');
          }
        },
        ajax: function(taskId, type, popId) {
          var _this = this;
          $('#loading-indicator').show();
          $.ajax({
            url: '../lib/php/loadResults.php?taskId='+taskId+'&type='+type+'&popId='+popId
          }).done(function(data) {
            if(data) {
              data = $.parseJSON(data);
              _this.draw(data);
            }
          });
        }
      } //_page END

      $(document).ready(function() {
        $("#nav").load("common.html");
        //_utils.loadOverview(1);
        $('#fileNav').fileTree({
            root: '../../../Tasks/',
            script: '../lib/php/fileTree/jqueryFileTree.php',
            expandSpeed: 300,
            collapseSpeed: 200,
            multiFolder: true
          }, function(file) {
              //alert(file);
        });

        _page.ajax('51f6d35da9d945c814b49d4c', 'color', 3);

        $("#updateButton").click(function() {
          alert($("#populselect").val());
        });

        $("#fileAllButton, #fileNoneButton").click(function() { //select all files or none 
          var ischeck = $(this).attr("id")==="fileAllButton",
              firstFile = null;
          $('[name^="fcb_"]').each(function(i, v) {
            if(i===0) {
              firstFile = v;
            }
            $(v).prop("checked", ischeck);
          });
          if(firstFile) { //fires change event to update files variable at page level
            $(firstFile).change();
          }
          if(ischeck) {
            _page.selecpicker.makeSingle('xmarker');
            _page.selecpicker.makeSingle('ymarker');
          } else {
            _page.selecpicker.makeMulti('xmarker');
            _page.selecpicker.makeMulti('ymarker');
          }
        });

        $('#fileNav').on('change', '[name^="fcb_"]', function(event){ //keeps currently selected files at page level
          var selectedFiles = '', attrName;
          $('[name^="fcb_"]:checked').each(function(i, v) {
            attrName = $(v).attr('name');
            selectedFiles += attrName.substring(attrName.indexOf("_")+1) + ",";
          });
          _page.files = selectedFiles.substring(0, selectedFiles.length-1)
        });
      });
    </script>
  </body>
</html>
